package http

import (
	"fmt"
	"{{.Name}}/model"
	"net/http"

	"github.com/huangbosbos/go-hutool/log"
	bm "github.com/huangbosbos/go-hutool/net/http/blademaster"
	"{{.Name}}/conf"
	"{{.Name}}/service"
)

var (
	srv *service.Service
)

// Init init
func Init(s *service.Service) {
	srv = s
	engine := bm.DefaultServer(conf.Conf.BM)
	engine.Ping(ping)
	initRouter(engine)
	if err := engine.Start(); err != nil {
		log.Error("engine.Start error(%v)", err)
		panic(err)
	}
	fmt.Println("curl http://localhost:8000/{{.Name}}/start")
	fmt.Println("curl http://localhost:8000/metadata")
	fmt.Println("curl http://localhost:8000/metrics")
	fmt.Println("curl http://localhost:8000/ping")
	fmt.Println("curl http://localhost:8000/debug/pprof/")
}

// initRouter init outer router api path.
func initRouter(e *bm.Engine) {
	g := e.Group("/{{.Name}}")
	{
		g.GET("/start", howToStart)
	}
}

// example for http request handler.
func howToStart(c *bm.Context) {
	k := &model.Strong{
		Hello: "Welcome to Golang !",
	}
	c.JSON(k, nil)
}

func ping(c *bm.Context) {
	if err := srv.Ping(c); err != nil {
		log.Error("ping error(%v)", err)
		c.AbortWithStatus(http.StatusServiceUnavailable)
	}
}
